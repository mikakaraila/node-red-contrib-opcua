<!--
 *
 * Copyright 2015 Valmet Automation Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
-->

<!--
 NodeRed node that will actually just use server side address.txt file to select opc ua variable.
 Simplified code and example flow to test functionality.

 @author <a href="mailto:mika.karaila@valmet.com">Mika Karaila</a> (Valmet Automation Inc.)
-->

<script type="text/x-red" data-template-name="OpcUaBrowse">
    <div class="form-row" id="node-input-item-row">
        <label for="node-input-item"><i class="icon-tag"></i> Item</label>
        <select type="text" id="node-input-item" style="display: inline-block; vertical-align: middle; width:60%;">
            <option selected disabled value="" >Choose a Item</option>
        </select>
        <div class="form-tips" id="node-input-item" style="margin-top:5px">
            <div>Select one of the item offered by browsing OPC UA address space.</div>
        </div>
    </div>
        <div class="form-row" id="node-input-datatype-row">
        <label for="node-input-datatype"><i class="icon-tag"></i> Type</label>
        <select type="text" id="node-input-datatype" style="display: inline-block; vertical-align: middle; width:60%;">
            <option selected disabled value="" >Choose a Type</option>
            <option selected value="opcua.DataType.Double" >Double</option>
            <option selected value="opcua.DataType.String" >String</option>
        </select>
        <div class="form-tips" id="node-input-item" style="margin-top:5px">
            <div>Select one of the OPC UA data types.</div>
        </div>
    </div>
    <div class="form-row">
        <label for="node-input-value"><i class="icon-tasks"></i> Value</label>
        <input type="text" id="node-input-value" placeholder="">
        <div class="form-tips" id="node-input-value" style="margin-top:5px">
            <div>Use value only if you want to write it.</div>
        </div>
    </div>
</script>

<script type="text/x-red" data-help-name="OpcUaBrowse">
    <p>Connect to endpoint: opc.tcp://host:port/UA/EndpointName.</p>
    <p>Item can be defined in input msg object:</p>
    <p><b>topic</b> contains OPC UA address and 
    <p><b>datatype></b> contains valid OPC UA type.</p>
    <p>If <b>payload</b> is empty value will be read from the OPC UA server otherwise value will be written to the server.</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('OpcUaBrowse',{
        category: 'advanced-function',
        color:"#3FADB5",
        defaults: {
            item: {value:"",required:true},
            datatype: {value:""},
            value: {value:""}
        },
        inputs:1,
        outputs:1,
        align: "right",
        icon: "arrow-in.png",
        label: function() {
            return this.item;
        },
        labelStyle: function() {
            return this.item?"node_label_italic":"";
        },
        oneditprepare: function() {
			var xmlhttp = new XMLHttpRequest();
			var url = "Address.txt";
			xmlhttp.onreadystatechange = function() {
				if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
					var addresses = xmlhttp.response;
					addresses = addresses.split('\n');
					var listbox = "";
					$("#node-input-item").append( '<option selected disabled value="" >Choose a Item</option>\n');
					for(i=0;i<addresses.length;i++){
                        listbox +='<option value="'+addresses[i]+'">'+addresses[i]+'</option>\n';
                    }
                    $("#node-input-item").append(listbox);

				}
			};
			xmlhttp.open("GET", url, true);
			xmlhttp.send();
        }
    });
</script>


